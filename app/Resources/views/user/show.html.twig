{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">
            <h1>
                {% if user.fullName %}
                    {{ user.fullName }}'s dashboard
                {% else %}
                    {{ user.email }}'s dashboard
                {% endif %}
                {% if (is_granted('ROLE_ADMIN')) or (app.user.id == user.id) %}
                <a href="{{ path('user_edit', {
                    id: user.id
                }) }}" class="pull-right btn btn-link">
                    <span class="fa fa-edit"></span>
                </a>
                {% endif %}
            </h1>
            <ul class="nav nav-tabs" id="main-tabs">
                <li class="active"><a data-toggle="tab" href="#user-info">My account</a></li>
                <li><a data-toggle="tab" href="#my-projects">My projects</a></li>
                <li><a data-toggle="tab" href="#my-current-namespaces">My current namespaces</a></li>
            </ul>
            <div class="tab-content">
                <div id="user-info" class="tab-pane fade in active">
                    <h3>My personal information</h3>
                    <table class="table">
                        <tbody>
                        <tr>
                            <th>Name</th>
                            <td>{{ user.fullName|default('-') }}</td>
                        </tr>
                        <tr>
                            <th>Email</th>
                            <td>{{ user.email }}</td>
                        </tr>
                        <tr>
                            <th>Institution</th>
                            <td>{{ user.institution|default('-') }}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div id="my-projects" class="tab-pane fade">
                    {% if userProjects|length < 1 or userProjects|length == 1 %}
                        <div class="pull-right add-div">
                            <a href="{{ path('project_new_user')}}"
                               class="btn btn-primary pull-right">
                                Add <span class="fa fa-plus-circle"></span>
                            </a>
                        </div>
                    {% endif %}
                    <h3>My projects</h3>
                    <table class="table table-striped" id="projects-table">
                        <thead>
                        <tr>
                            <th>Project name</th>
                            <th>Last updated</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for userProject in userProjects %}
                            <tr>
                                <td>
                                    <a href="{{ path('project_show', {
                                        'id': userProject.project.id
                                    }) }}">
                                        {{ userProject.project.standardLabel }}
                                    </a>
                                    {% if userProject.project.standardLabel == app.user.currentActiveProject.standardLabel %}
                                        <span class="label label-success" style="margin-left: 10px;"><i class="fas fa-dot-circle"></i> Active</span>
                                    {% endif %}
                                </td>
                                <td>{{ userProject.project.modificationTime|date('Y-m-d') }}</td>
                                <td>
                                    {% if userProject.project.standardLabel != app.user.currentActiveProject.standardLabel %}
                                    <a href="{{ path('user_edit_current_active_project', {'project': userProject.project.id}) }}" class="btn btn-xs btn-primary">
                                        <i class="far fa-dot-circle"></i> Activate
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <div class="alert alert-info">
                        <p><i class="fas fa-info-circle"></i>&nbsp;If you are interested in joining an <a href="{{ path('app_project_list') }}" target="_blank">existing project</a>, please write to <a href="mailto:ontome@dataforhistory.org">ontome@dataforhistory.org</a> indicating the name of the <a href="{{ path('app_project_list') }}" target="_blank">project</a> and the reason of your request. </p>
                    </div>
                </div>
                <div id="my-current-namespaces" class="tab-pane fade">
                    <h3>Namespaces whose classes and properties are displayed</h3>
                    <div class="row">
                        <div class="col-lg-6">
                            <h4>Managed by the project</h4>
                            <div>
                                {% set isActive = false %}
                                {% if defaultNamespace in activeNamespaces %}
                                    {% set isActive = true %}
                                {% endif %}
                                {% if isActive %}
                                <a href="#"><span class="glyphicon glyphicon-check text-primary" aria-hidden="true"></span></a>
                                <a href="{{ path('namespace_show', {'id': defaultNamespace.id}) }}">{{ defaultNamespace.standardLabel }}</a>
                                {% else %}
                                <a href="#"><span class="glyphicon glyphicon-unchecked text-muted" aria-hidden="true"></span></a>
                                <a class="text-muted" href="{{ path('namespace_show', {'id': defaultNamespace.id}) }}">{{ defaultNamespace.standardLabel }}</a>
                                {% endif %}
                            </div>
                            {% if defaultNamespace.referencedNamespaceAssociations|length > 0 %}
                                <div class="small text-muted"><strong><em>Referenced :</em></strong></div>
                            {% endif %}
                            <ul>
                                {% for referencedNamespaceAssociation in defaultNamespace.referencedNamespaceAssociations %}
                                    <li class="list-unstyled"><em class="text-muted">{{ referencedNamespaceAssociation.namespace.standardLabel }}</em></li>
                                {% endfor %}
                            </ul>
                            <h4>Additional namespaces</h4>
                            {% if additionalNamespaces|length == 0 %}
                                <p class="text-muted"><em>No additional namespace added, please pick one below.</em></p>
                            {% endif %}
                            {% for additionalNamespace in additionalNamespaces if additionalNamespace != defaultNamespace %}
                                <a href="#"><span class="glyphicon glyphicon-remove text-danger" aria-hidden="true"></span></a>
                                <a href="{{ path('namespace_show', {'id': additionalNamespace.id}) }}">{{ additionalNamespace.standardLabel }}</a>
                                {% if additionalNamespace.referencedNamespaceAssociations|length > 0 %}
                                    <div class="small"><strong><em>Referenced :</em></strong></div>
                                {% endif %}
                                <ul>
                                    {% for referencedNamespaceAssociation in additionalNamespace.referencedNamespaceAssociations if referencedNamespaceAssociation.namespace is not null %}
                                        <li class="list-unstyled"><em>{{ referencedNamespaceAssociation.namespace.standardLabel }}</em></li>
                                    {% endfor %}
                                </ul>
                            {% endfor %}
                            <h4>Pick an additional namespace</h4>
                            <select id="select-root-namespace">
                            {% for rootNamespace in rootNamespaces %}
                                <option value="{{ rootNamespace.id }}">{{ rootNamespace.standardLabel }}</option>
                            {% endfor %}
                            </select>
                            <div id="loading-icon">
                                <span class="fas fa-spinner fa-spin"></span>
                            </div>
                            <ul class="list-group" id="chosable-namespaces-list" style="margin-top: 10px;">
                            </ul>
                        </div>
                        <div class="col-lg-6">
                            <h4>Selected from project profiles</h4>
                            {% if app.user.currentActiveProject.profiles|length == 0 %}
                                <p class="text-muted"><em>No one profile uses this project.</em></p>
                            {% endif %}
                            {% for profile in app.user.currentActiveProject.profiles %}
                                <div>
                                    {% set isActiveProfile = false %}
                                    {% if profile in activeProfiles %}
                                        {% set isActiveProfile = true %}
                                    {% endif %}
                                    {% if isActiveProfile %}
                                    <a href="#"><span class="glyphicon glyphicon-check" aria-hidden="true"></span></a>
                                    <strong>Profile : <a href="{{ path('profile_show', {'id': profile.id}) }}">{{ profile }}</a></strong>
                                    {% else %}
                                    <a href="#"><span class="glyphicon glyphicon-unchecked text-muted" aria-hidden="true"></span></a>
                                    <strong class="text-muted">Profile : <a class="text-muted" href="{{ path('profile_show', {'id': profile.id}) }}">{{ profile }}</a></strong>
                                    {% endif %}
                                </div>
                                {% if profile.namespaces|length == 0 %}
                                    <p class="text-muted"><em>No namespace is associated with this profile.</em></p>
                                {% endif %}
                                <ul style="margin-bottom: 20px;">
                                {% for namespace in profile.namespaces %}
                                    {% set isActive = false %}
                                    {% if namespace in activeNamespaces %}
                                        {% set isActive = true %}
                                    {% endif %}
                                    {% if isActive %}
                                        <li class="list-unstyled" style="margin-left: -30px;">
                                            <a href="#"><span class="glyphicon glyphicon-check" aria-hidden="true"></span></a>
                                            <a href="{{ path('namespace_show', {'id': namespace.id}) }}">{{ namespace.standardLabel }}</a>
                                        </li>
                                    {% else %}
                                        <li class="list-unstyled" style="margin-left: -30px;">
                                            <a href="#"><span class="glyphicon glyphicon-unchecked text-muted" aria-hidden="true"></span></a>
                                            <a class="text-muted" href="{{ path('namespace_show', {'id': namespace.id}) }}">{{ namespace.standardLabel }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                </ul>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Onglet My Projects
            $('#projects-table').DataTable({
                "order": [[2, 'asc']]
            });

            // Onglet My current namespaces
            $('#loading-icon').hide(0);
            $('#select-root-namespace').select2({
                width: '100%',
                sorter: function(data) {
                    /* Sort data using lowercase comparison */
                    return data.sort(function (a, b) {
                        a = a.text.toLowerCase();
                        b = b.text.toLowerCase();
                        if (a > b) {
                            return 1;
                        } else if (a < b) {
                            return -1;
                        }
                        return 0;
                    });
                }
            });

            $('#select-root-namespace').on('select2:select', function (e) {
                $('#loading-icon').show(0);
                $('#chosable-namespaces-list').empty();
                var selectedValue = e.params.data.id;
                var url = '{{ path("namespaces_by_root_id_list_json", {'id': 'selectedValue'}) }}';
                url = url.replace("selectedValue", selectedValue);
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success:function(data){
                        $('#loading-icon').hide(0);

                        // handling the response data from the controller
                        if(data.status == 'Error'){
                            console.log("[API] ERROR: "+data.message);
                        }
                        if(data.status == 'Success'){
                            $.each(data.namespaces, function(key, val){
                                $("#chosable-namespaces-list").append($("<a class=\"list-group-item pickable-namespace\" id="+val.id+">"+val.standardLabel+"</a>"));
                            });
                        }
                    }
                });
            });

            $(document).on("mouseenter", ".pickable-namespace", function() {
                $(this).prepend($("<span><i class=\"fas fa-plus\"></i>&nbsp;</span>"));
            });

            $(document).on("mouseleave", ".pickable-namespace", function() {
                $(this).find(":first-child").remove();
            });

            {#
            $(document).on("click", ".pickable-namespace", function() {
                var selectedValue = $(this).attr("id");
                var profileID = {{ profile.id }}
                var url = '{{ path("profile_namespace_association", {'profile' : 'profileID','namespace': 'selectedValue'}) }}';
                url = url.replace("profileID", profileID);
                url = url.replace("selectedValue", selectedValue);
                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: 'json',
                    success:function(data){

                        // handling the response data from the controller
                        if(data.status == 'Error'){
                            console.log("[API] ERROR: "+data.message);
                        }
                        if(data.status == 'Success'){
                            selectableClassesTable.ajax.reload();
                        }
                    }
                });
                var urlNamespace = '{{ path('namespace_show', {'id' : 'selectedValue'}) }}';
                urlNamespace = urlNamespace.replace('selectedValue', selectedValue);
                $("#empty-namespace-list-message").remove();
                $("#select-root-namespace option:selected").remove();
                $("#used-namespaces-list").append($('<div class="row"><a href="#namespaces" class="remove-namespace" data-id="'+selectedValue+'"><span class="glyphicon glyphicon-remove text-danger" aria-hidden="true"></span></a><a href="'+urlNamespace+'">'+$(this).text()+'</a><span class="loading-icon2" data-id="'+selectedValue+'">&nbsp;<span class="fas fa-spinner fa-spin"></span></span></div>'));
                $(".loading-icon2[data-id='"+selectedValue+"']").hide(0);
                $("#chosable-namespaces-list").empty();
            });

            $(document).on("click", ".remove-namespace", function() {
                var selectedValue = $(this).data("id");
                var profileID = {{ profile.id }}
                    $(".loading-icon2[data-id='"+selectedValue+"']").show(0);
                var url = '{{ path("profile_namespace_disassociation", {'profile' : 'profileID','namespace': 'selectedValue'}) }}';
                url = url.replace("profileID", profileID);
                url = url.replace("selectedValue", selectedValue);
                $.ajax({
                    url: url,
                    type: 'DELETE',
                    dataType: 'json',
                    success:function(data){
                        selectableClassesTable.ajax.reload();
                    },
                    statusCode: {
                        204: function () {
                            $(".remove-namespace[data-id='"+selectedValue+"']").parent().remove();
                        }
                    }
                });

            });#}
        } );
    </script>
{% endblock %}